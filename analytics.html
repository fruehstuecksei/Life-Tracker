<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LifeTracker ‚Äì Analytics mit Trend</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body{font-family:Inter,sans-serif;background:#0f172a;color:#f1f5f9;padding:20px;padding-bottom:120px}
h1{text-align:center;margin-bottom:20px}
.modeBtn,.timeChip,.tagChip,.categoryChip,.dataModeChip{padding:6px 12px;margin:4px;border-radius:10px;border:none;cursor:pointer;font-weight:600;background:#1e293b;color:white;opacity:.6;transition:.2s}
.modeBtn.active,.timeChip.active,.tagChip.active,.categoryChip.active,.dataModeChip.active{opacity:1;background:#3b82f6}
.select-bar{display:flex;flex-wrap:wrap;justify-content:center;gap:8px;margin-bottom:15px}
.chart-container{background: rgba(255,255,255,0.06);padding:20px;border-radius:12px;margin-bottom:30px}
#statsBox{text-align:center;margin-bottom:20px;font-weight:600}

/* Bottom Navigation */
#bottomNav{position:fixed;bottom:0;left:0;right:0;height:60px;background:rgba(255,255,255,0.06);backdrop-filter:blur(20px);border-top:1px solid rgba(255,255,255,0.1);display:flex;justify-content:space-around;align-items:center}
.navItem{color:#f1f5f9;font-size:26px;text-decoration:none;opacity:.6}
.navItem.active{opacity:1;transform:translateY(-4px)}
</style>
</head>
<body>

<h1>LifeTracker Analytics</h1>

<!-- Timer / Counter -->
<div id="modeBar" class="select-bar">
    <button class="modeBtn active" data-mode="timer">Timer</button>
    <button class="modeBtn" data-mode="counter">Counter</button>
</div>

<!-- Zeitraum -->
<div id="timeBar" class="select-bar">
    <div class="timeChip active" data-range="week">Woche</div>
    <div class="timeChip" data-range="month">Monat</div>
    <div class="timeChip" data-range="total">Gesamt</div>
</div>

<!-- Datenmodus Toggle -->
<div id="dataModeBar" class="select-bar">
    <div class="dataModeChip active" data-mode="value">Zeit/Anzahl</div>
    <div class="dataModeChip" data-mode="success">Erfolgsquote</div>
</div>

<!-- Tag Auswahl -->
<div id="tagBar" class="select-bar"></div>

<!-- Kategorien Auswahl -->
<div id="categoryBar" class="select-bar"></div>

<!-- Statistiken -->
<div id="statsBox"></div>

<!-- Diagramm -->
<div class="chart-container">
    <canvas id="mainChart"></canvas>
</div>

<nav id="bottomNav">
    <a href="index.html" class="navItem">üè†</a>
    <a href="dashboard.html" class="navItem">üìä</a>
    <a href="analytics.html" class="navItem active">üìà</a>
</nav>

<script>
/* -------------------- Storage Data -------------------- */
let TIMER_DATA = JSON.parse(localStorage.getItem("lifetracker_timer")) || [];
let COUNTER_DATA = JSON.parse(localStorage.getItem("lifetracker_counter")) || [];
let CATEGORY_TAGS = JSON.parse(localStorage.getItem("lifetracker_tags")) || {};
let GOALS = JSON.parse(localStorage.getItem("lifetracker_goals")) || {};

/* -------------------- State -------------------- */
let selectedMode="timer";
let selectedRange="week";
let selectedDataMode="value"; // value=Zeit/Anzahl, success=Erfolgsquote
let selectedTag="";
let selectedCategory="Alle";
let mainChart;

/* -------------------- Helper Functions -------------------- */
function isInRange(ts, range){
    const now=new Date();
    let start;
    if(range==="week") start=new Date(now.getTime()-6*24*3600*1000);
    else if(range==="month") start=new Date(now.getTime()-29*24*3600*1000);
    else start=new Date(0);
    return ts*1000 >= start.getTime();
}
function getDateLabel(ts){ const d=new Date(ts*1000); return `${d.getDate()}.${d.getMonth()+1}`; }
function isGoalAchieved(entry){
    const val = selectedMode==="timer"?Math.floor(Number(entry.duration_s)/60):Number(entry.value);
    const goalVal = GOALS[entry.category]?.value || 0;
    return goalVal>0 && val >= goalVal;
}

/* -------------------- UI Functions -------------------- */
function renderModeBar(){document.querySelectorAll("#modeBar .modeBtn").forEach(btn=>{btn.classList.toggle("active",btn.dataset.mode===selectedMode);btn.onclick=()=>{selectedMode=btn.dataset.mode; renderModeBar(); loadChart();}});}
function renderTimeBar(){document.querySelectorAll("#timeBar .timeChip").forEach(chip=>{chip.classList.toggle("active",chip.dataset.range===selectedRange);chip.onclick=()=>{selectedRange=chip.dataset.range; renderTimeBar(); loadChart();}});}
function renderDataModeBar(){document.querySelectorAll("#dataModeBar .dataModeChip").forEach(chip=>{chip.classList.toggle("active",chip.dataset.mode===selectedDataMode); chip.onclick=()=>{ selectedDataMode = chip.dataset.mode; renderDataModeBar(); loadChart(); };});}
function renderTagBar(){const c=document.getElementById("tagBar");c.innerHTML="";const allChip=document.createElement("div");allChip.textContent="Alle";allChip.className="tagChip "+(selectedTag==="");allChip.onclick=()=>{selectedTag="";renderTagBar();renderCategoryBar();loadChart();};c.appendChild(allChip);Object.values(CATEGORY_TAGS).flat().forEach(t=>{const chip=document.createElement("div");chip.textContent=t;chip.className="tagChip "+(selectedTag===t?"active":"");chip.onclick=()=>{selectedTag=t;renderTagBar();renderCategoryBar();loadChart();};c.appendChild(chip);});}
function renderCategoryBar(){const c=document.getElementById("categoryBar");c.innerHTML="";if(!selectedTag)return;const allChip=document.createElement("div");allChip.textContent="Alle";allChip.className="categoryChip "+(selectedCategory==="Alle"?"active":"");allChip.onclick=()=>{selectedCategory="Alle";renderCategoryBar();loadChart();};c.appendChild(allChip);Object.keys(CATEGORY_TAGS).filter(cat=>CATEGORY_TAGS[cat]?.includes(selectedTag)).forEach(cat=>{const chip=document.createElement("div");chip.textContent=cat;chip.className="categoryChip "+(selectedCategory===cat?"active":"");chip.onclick=()=>{selectedCategory=cat;renderCategoryBar();loadChart();};c.appendChild(chip);});}

/* -------------------- Load Chart -------------------- */
function loadChart(){
    const ctx=document.getElementById("mainChart"); if(mainChart) mainChart.destroy();
    let labels=[], dataValues=[];
    const source = selectedMode==="timer"?TIMER_DATA:COUNTER_DATA;

    if(selectedDataMode==="success"){
        const grouped = {};
        source.forEach(e=>{
            const ts = selectedMode==="timer"?Number(e.start_ts):Number(e.timestamp);
            if(!isInRange(ts,selectedRange)) return;
            if(selectedTag && !(CATEGORY_TAGS[e.category]||[]).includes(selectedTag)) return;
            if(selectedCategory!=="Alle" && e.category!==selectedCategory) return;

            const goalType = GOALS[e.category]?.type || "daily";
            let periodLabel;
            const d = new Date(ts*1000);
            if(goalType==="weekly"){
                const onejan = new Date(d.getFullYear(),0,1);
                const week = Math.ceil((((d - onejan) / 86400000) + onejan.getDay()+1)/7);
                periodLabel = `${d.getFullYear()}-W${week}`;
            } else {
                periodLabel = getDateLabel(ts);
            }

            grouped[periodLabel] = grouped[periodLabel] || [];
            grouped[periodLabel].push(e);
        });

        labels = Object.keys(grouped).sort();
        dataValues = labels.map(label=>{
            const entries = grouped[label];
            const achieved = entries.filter(isGoalAchieved).length;
            return achieved>0 ? 100 : 0;
        });

        const totalAchieved = dataValues.filter(v=>v===100).length;
        const overall = Math.round(totalAchieved / dataValues.length * 100);
        document.getElementById("statsBox").innerHTML=`Gesamt: ${overall}% (Ziel erreicht in ${totalAchieved}/${dataValues.length} Intervallen)`;

        const trend = linearTrend(dataValues);
        mainChart = new Chart(ctx,{
            type:"bar",
            data:{labels,datasets:[
                {label:"Erfolgsquote", data:dataValues, backgroundColor:"#3b82f6"},
                {label:"Trend", type:"line", data:trend, borderColor:"#facc15", borderWidth:2, fill:false, tension:0}
            ]},
            options:{responsive:true, scales:{y:{beginAtZero:true, max:100}}}
        });
        return;
    }

    // -------------------- Wert/Anzahl Modus --------------------
    const now = new Date();
    let start;
    if(selectedRange==="week") start = new Date(now.getTime() - 6*24*3600*1000); 
    else if(selectedRange==="month") start = new Date(now.getTime() - 29*24*3600*1000); 
    else start = new Date(0);

    labels = [];
    const totalsPerDay = {};
    for(let d = new Date(start); d <= now; d.setDate(d.getDate()+1)){
        const label = `${d.getDate()}.${d.getMonth()+1}`;
        labels.push(label);
        totalsPerDay[label] = 0;
    }

    source.forEach(e=>{
        const ts = selectedMode==="timer"?Number(e.start_ts):Number(e.timestamp);
        if(!isInRange(ts, selectedRange)) return;
        if(selectedTag && !(CATEGORY_TAGS[e.category]||[]).includes(selectedTag)) return;
        if(selectedCategory!=="Alle" && e.category!==selectedCategory) return;

        const val = selectedMode==="timer"?Math.floor(Number(e.duration_s)/60):Number(e.value);
        const label = getDateLabel(ts);
        if(totalsPerDay[label]!==undefined) totalsPerDay[label] += val;
    });

    dataValues = labels.map(l => totalsPerDay[l]);
    const total = dataValues.reduce((a,b)=>a+b,0);
    const avg = Math.round(total/Math.max(dataValues.length,1));
    document.getElementById("statsBox").innerHTML=`Gesamt: ${total} ${selectedMode==="timer"?"min":"x"} , √ò: ${avg}`;

    const trend = linearTrend(dataValues);
    mainChart = new Chart(ctx,{
        type:"bar",
        data:{labels, datasets:[
            {label:selectedMode==="timer"?"Zeit":"Anzahl", data:dataValues, backgroundColor:"#3b82f6"},
            {label:"Trend", type:"line", data:trend, borderColor:"#facc15", borderWidth:2, fill:false, tension:0}
        ]},
        options:{responsive:true}
    });
}

/* -------------------- Trendlinie -------------------- */
function linearTrend(values){
    const n = values.length;
    if(n<2) return Array(n).fill(values[0]||0);
    const sumX = values.reduce((a,_,i)=>a+i,0);
    const sumY = values.reduce((a,b)=>a+b,0);
    const sumXY = values.reduce((a,v,i)=>a+i*v,0);
    const sumX2 = values.reduce((a,_,i)=>a+i*i,0);
    const slope = (n*sumXY-sumX*sumY)/(n*sumX2-sumX*sumX);
    const intercept = (sumY - slope*sumX)/n;
    return values.map((_,i)=>slope*i+intercept);
}

/* -------------------- Init -------------------- */
renderModeBar(); renderTimeBar(); renderDataModeBar(); renderTagBar(); renderCategoryBar(); loadChart();
</script>

</body>
</html>
