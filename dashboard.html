<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LifeTracker ‚Äì Dashboard Heute</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    body {
        font-family: Inter, sans-serif;
        background: #0f172a;
        color: #f1f5f9;
        padding: 20px;
        padding-bottom: 100px; /* Platz f√ºr Men√º */
    }

    h1 {
        text-align: center;
        margin-bottom: 20px;
    }

    #xpBox {
        background: rgba(255,255,255,0.06);
        padding: 15px;
        border-radius: 12px;
        margin-bottom: 20px;
        text-align: center;
        font-size: 18px;
        font-weight: 600;
    }

    #chartContainer {
        background: rgba(255,255,255,0.06);
        padding: 20px;
        border-radius: 12px;
    }

    /* Bottom Navigation */
    #bottomNav {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        height: 60px;
        background: rgba(255,255,255,0.06);
        backdrop-filter: blur(20px);
        border-top: 1px solid rgba(255,255,255,0.1);
        display: flex;
        justify-content: space-around;
        align-items: center;
        z-index: 999;
    }

    .navItem {
        color: #f1f5f9;
        font-size: 26px;
        text-decoration: none;
        opacity: 0.6;
        transition: 0.2s;
    }

    .navItem.active {
        opacity: 1;
        transform: translateY(-4px);
    }
</style>
</head>

<body>

<h1>üìä Dashboard ‚Äì Heute</h1>

<div style="text-align:center; margin-bottom:20px;">
    <button id="refreshBtn" onclick="loadData()" style="
        padding:10px 16px;
        border-radius:12px;
        border:none;
        cursor:pointer;
        font-weight:600;
        background:#3b82f6;
        color:white;
        transition:0.2s;
    ">
        üîÑ Aktualisieren
    </button>
</div>

<div id="xpBox">
    XP heute: <span id="xpToday">0</span>  
    |  
    XP gesamt: <span id="xpTotal">0</span>
</div>

<div id="chartContainer">
    <canvas id="todayChart"></canvas>
</div>

<!-- Bottom Navigation -->
<nav id="bottomNav">
    <a href="index.html" class="navItem" id="navHome">üè†</a>
    <a href="dashboard.html" class="navItem" id="navDashboard">üìä</a>
    <a href="analytics.html" class="navItem" id="navAnalytics">üìà</a>
</nav>

<script>
// Aktive Seite markieren
const page = location.pathname.split("/").pop();
if (page.includes("index")) document.getElementById("navHome").classList.add("active");
if (page.includes("dashboard")) document.getElementById("navDashboard").classList.add("active");
if (page.includes("analytics")) document.getElementById("navAnalytics").classList.add("active");

// URLs
const TIMER_URL = "https://n8n.srv1377935.hstgr.cloud/webhook/lifetracker.timer";
const COUNTER_URL = "https://n8n.srv1377935.hstgr.cloud/webhook/lifetracker.counter";

// Ziele pro Kategorie
const GOALS = {
    sleep: 8 * 3600,
    sport: 3600,
    pushups: 50,
    cycle: 20
};

// XP Regeln
function calculateXP(category, value) {
    if (!GOALS[category]) return 0;
    if (value >= GOALS[category]) return 10;
    return Math.floor((value / GOALS[category]) * 10);
}

function isToday(ts) {
    const d = new Date(ts * 1000);
    const now = new Date();
    return d.getFullYear() === now.getFullYear() &&
           d.getMonth() === now.getMonth() &&
           d.getDate() === now.getDate();
}

// Ladeanimation
function setLoading(isLoading) {
    const btn = document.getElementById("refreshBtn");
    if (!btn) return;

    if (isLoading) {
        btn.disabled = true;
        btn.innerHTML = "‚è≥ L√§dt‚Ä¶";
        btn.style.opacity = "0.6";
    } else {
        btn.disabled = false;
        btn.innerHTML = "üîÑ Aktualisieren";
        btn.style.opacity = "1";
    }
}

async function loadData() {
    setLoading(true);

    try {
        const timerData = await fetch(TIMER_URL).then(r => r.json());
        const counterData = await fetch(COUNTER_URL).then(r => r.json());

        const todayTotals = {};

        // TIMER
        timerData.forEach(entry => {
            if (!isToday(entry.start_ts)) return;
            const cat = entry.category;
            todayTotals[cat] = (todayTotals[cat] || 0) + entry.duration_s;
        });

        // COUNTER
        counterData.forEach(entry => {
            if (!isToday(entry.timestamp)) return;
            const cat = entry.category;
            todayTotals[cat] = (todayTotals[cat] || 0) + entry.value;
        });

        // XP Berechnung
        let xpToday = 0;
        let xpTotal = 0;

        Object.entries(todayTotals).forEach(([cat, val]) => {
            xpToday += calculateXP(cat, val);
            xpTotal += calculateXP(cat, val);
        });

        document.getElementById("xpToday").textContent = xpToday;
        document.getElementById("xpTotal").textContent = xpTotal;

        renderChart(todayTotals);

    } catch (err) {
        alert("Fehler beim Laden der Daten: " + err);
    }

    setLoading(false);
}

let chart;

function renderChart(data) {
    const ctx = document.getElementById("todayChart");

    if (chart) chart.destroy();

    const labels = Object.keys(data);
    const values = Object.values(data);

    const goalLines = labels.map(cat => GOALS[cat] || null);

    chart = new Chart(ctx, {
        type: "bar",
        data: {
            labels,
            datasets: [
                {
                    label: "Heute",
                    data: values,
                    backgroundColor: "#3b82f6"
                },
                {
                    label: "Ziel",
                    data: goalLines,
                    type: "line",
                    borderColor: "#22c55e",
                    borderWidth: 2,
                    pointRadius: 0
                }
            ]
        },
        options: {
            responsive: true,
            scales: {
                y: { beginAtZero: true }
            }
        }
    });
}

loadData();
</script>

</body>
</html>


