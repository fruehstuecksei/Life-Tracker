<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LifeTracker ‚Äì Dashboard Heute</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { font-family: Inter, sans-serif; background: #0f172a; color: #f1f5f9; padding: 20px; padding-bottom: 120px; }
h1 { text-align: center; margin-bottom: 20px; }
#xpBox { background: rgba(255,255,255,0.06); padding: 15px; border-radius: 12px; margin-bottom: 20px; text-align: center; font-size: 18px; font-weight: 600; }
#chartContainer { background: rgba(255,255,255,0.06); padding: 20px; border-radius: 12px; margin-bottom: 30px; }
#goalEditor, #folderManager { background: rgba(255,255,255,0.06); padding: 20px; border-radius: 12px; margin-bottom: 30px; }
.goalRow { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
.goalRow select[multiple] { height: 80px; width: 150px; }
.goalRow input { width: 120px; padding: 6px; border-radius: 8px; border: none; background: #1e293b; color: white; text-align: right; }
.deleteBtn { background: #ef4444; border: none; padding: 6px 10px; border-radius: 8px; cursor: pointer; color: white; font-weight: 600; }
.addSection { margin-top: 20px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1); }
select, input[type="number"], input[type="text"] { width: 100%; padding: 8px; border-radius: 8px; border: none; background: #1e293b; color: white; margin-bottom: 10px; }
#bottomNav { position: fixed; bottom: 0; left: 0; right: 0; height: 60px; background: rgba(255,255,255,0.06); backdrop-filter: blur(20px); border-top: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-around; align-items: center; z-index: 999; }
.navItem { color: #f1f5f9; font-size: 26px; text-decoration: none; opacity: 0.6; transition: 0.2s; }
.navItem.active { opacity: 1; transform: translateY(-4px); }
.modeBtn { padding:8px 14px; margin: 0 4px; border-radius:10px; border:none; cursor:pointer; font-weight:600; background:#1e293b; color:white; opacity:0.6; transition:0.2s; }
.modeBtn.active { opacity:1; background:#3b82f6; }
</style>
</head>
<body>
<h1>üìä Dashboard ‚Äì Heute</h1>

<!-- Refresh + Mode -->
<div style="text-align:center; margin-bottom:20px;">
  <button id="refreshBtn" onclick="loadData()" style=" padding:10px 16px; border-radius:12px; border:none; cursor:pointer; font-weight:600; background:#3b82f6; color:white; "> üîÑ Aktualisieren </button>
</div>
<div style="text-align:center; margin-bottom:20px;">
  <button onclick="setMode('timer')" id="btnTimer" class="modeBtn active">Timer</button>
  <button onclick="setMode('counter')" id="btnCounter" class="modeBtn">Counter</button>
</div>

<!-- XP Anzeige -->
<div id="xpBox"> XP heute: <span id="xpToday">0</span> | Gesamt: <span id="xpTotal">0</span> </div>

<!-- Chart -->
<div id="chartContainer">
  <canvas id="todayChart"></canvas>
</div>

<!-- Ordnerverwaltung -->
<div id="folderManager">
  <h2>üìÇ Ordner & Kategorien</h2>
  <div>
    <label>Ordner w√§hlen:</label>
    <select id="folderSelect" onchange="renderOvercategories()">
      <option value="timer">Timer</option>
      <option value="counter">Counter</option>
    </select>
  </div>
  <div id="overcategoryContainer"></div>
  <div class="addSection">
    <h4>Neue √úberkategorie hinzuf√ºgen</h4>
    <input id="newOvercategoryName" placeholder="Name">
    <button onclick="addOvercategory()">+ Hinzuf√ºgen</button>
  </div>
</div>

<!-- üéØ Ziele -->
<div id="goalEditor">
  <h3>Ziele einstellen (<span id="goalModeLabel">Timer</span>)</h3>
  <div id="goalList"></div>
  <div class="addSection">
    <h4>Neues Ziel hinzuf√ºgen</h4>
    <label>Kategorie ausw√§hlen:</label>
    <select id="addCategory"></select>
    <label>Zielwert:</label>
    <input id="addValue" type="number" min="0" placeholder="Minuten oder Anzahl">
    <button onclick="addGoal()" style=" margin-top:10px; padding:8px 14px; border:none; border-radius:10px; background:#3b82f6; color:white; font-weight:600; cursor:pointer; ">Hinzuf√ºgen</button>
  </div>
  <button onclick="saveGoals()" style=" margin-top:20px; padding:8px 14px; border:none; border-radius:10px; background:#3b82f6; color:white; font-weight:600; cursor:pointer; ">Speichern</button>
</div>

<!-- Navigation -->
<nav id="bottomNav">
  <a href="index.html" class="navItem" id="navHome">üè†</a>
  <a href="dashboard.html" class="navItem" id="navDashboard">üìä</a>
  <a href="analytics.html" class="navItem" id="navAnalytics">üìà</a>
</nav>

<script>
// =====================
// Daten
// =====================
const TIMER_URL = "https://n8n.srv1377935.hstgr.cloud/webhook/lifetracker.timer";
const COUNTER_URL = "https://n8n.srv1377935.hstgr.cloud/webhook/lifetracker.counter";

let CATEGORY_LIST = JSON.parse(localStorage.getItem("lifetracker_categories")) || { timer: ["sleep","sport","eating"], counter: ["pushups","pullups"] };
let GOALS = JSON.parse(localStorage.getItem("lifetracker_goals")) || {};
let FOLDERS = JSON.parse(localStorage.getItem("lifetracker_folders")) || { timer:{}, counter:{} };
let categoryTypes = {};
let currentMode = "timer";
let chart;

// =====================
// Helfer
// =====================
function normalizeArray(data) { if (!data) return []; if (Array.isArray(data)) return data; if (typeof data === "object") return [data]; return []; }
function isToday(ts) { if (!ts) return false; const d = new Date(ts*1000); const t = new Date(); return d.toDateString()===t.toDateString(); }
function calculateXP(cat,val) { if(!GOALS[cat]) return 0; return val>=GOALS[cat].value?10:0; }

// =====================
// Modus wechseln
// =====================
function setMode(mode){
  currentMode=mode;
  document.getElementById("btnTimer").classList.remove("active");
  document.getElementById("btnCounter").classList.remove("active");
  document.getElementById("btn"+mode.charAt(0).toUpperCase()+mode.slice(1)).classList.add("active");
  document.getElementById("goalModeLabel").textContent = mode==="timer"?"Timer":"Counter";
  loadData();
}

// =====================
// Ordner & √úberkategorien
// =====================
function renderOvercategories(){
  const folder = document.getElementById("folderSelect").value;
  const container = document.getElementById("overcategoryContainer");
  container.innerHTML = "";
  const overs = FOLDERS[folder]||{};
  Object.entries(overs).forEach(([overName, subCats])=>{
    const div = document.createElement("div");
    div.className="goalRow";
    const options = CATEGORY_LIST[folder].map(cat=>`<option value="${cat}" ${subCats.includes(cat)?"selected":""}>${cat}</option>`).join("");
    div.innerHTML = `<strong>${overName}</strong>
      <select multiple onchange="updateSubcategories('${folder}','${overName}',this)">${options}</select>
      <button class="deleteBtn" onclick="deleteOvercategory('${folder}','${overName}')">üóëÔ∏è</button>`;
    container.appendChild(div);
  });
}

function addOvercategory(){
  const folder = document.getElementById("folderSelect").value;
  const name = document.getElementById("newOvercategoryName").value.trim();
  if(!name) return alert("Name eingeben!");
  if(!FOLDERS[folder]) FOLDERS[folder]={};
  if(FOLDERS[folder][name]) return alert("√úberkategorie existiert bereits!");
  FOLDERS[folder][name]=[];
  localStorage.setItem("lifetracker_folders",JSON.stringify(FOLDERS));
  document.getElementById("newOvercategoryName").value="";
  renderOvercategories();
}

function updateSubcategories(folder,overName,sel){
  const selected = Array.from(sel.selectedOptions).map(o=>o.value);
  FOLDERS[folder][overName]=selected;
  localStorage.setItem("lifetracker_folders",JSON.stringify(FOLDERS));
}

function deleteOvercategory(folder,overName){
  if(!confirm(`√úberkategorie "${overName}" l√∂schen?`)) return;
  delete FOLDERS[folder][overName];
  localStorage.setItem("lifetracker_folders",JSON.stringify(FOLDERS));
  renderOvercategories();
}

// =====================
// Ziele
// =====================
function renderGoalEditor(){
  const container = document.getElementById("goalList");
  container.innerHTML="";
  Object.entries(GOALS).forEach(([cat,obj])=>{
    if(obj.type!==currentMode) return;
    container.innerHTML+=`<div class="goalRow"><span>${cat}</span><input id="goal_${cat}" type="number" min="0" value="${obj.value}"><button class="deleteBtn" onclick="deleteGoal('${cat}')">L√∂schen</button></div>`;
  });
  renderAddGoalDropdown();
}

function renderAddGoalDropdown(){
  const dropdown = document.getElementById("addCategory");
  dropdown.innerHTML="";
  const list = CATEGORY_LIST[currentMode]||[];
  if(list.length===0){ dropdown.innerHTML=`<option value="">Keine Kategorien verf√ºgbar</option>`; dropdown.disabled=true; return; }
  dropdown.disabled=false;
  list.forEach(cat=>{ dropdown.innerHTML+=`<option value="${cat}">${cat}</option>`; });
}

function addGoal(){
  const cat=document.getElementById("addCategory").value;
  const val=Number(document.getElementById("addValue").value);
  if(!cat||isNaN(val)||val<=0){ alert("Bitte Kategorie und g√ºltigen Zielwert eingeben."); return; }
  GOALS[cat]={type:currentMode,value:val};
  localStorage.setItem("lifetracker_goals",JSON.stringify(GOALS));
  document.getElementById("addValue").value="";
  loadData();
}

function deleteGoal(cat){
  delete GOALS[cat];
  localStorage.setItem("lifetracker_goals",JSON.stringify(GOALS));
  loadData();
}

function saveGoals(){
  Object.keys(GOALS).forEach(cat=>{
    if(GOALS[cat].type!==currentMode) return;
    const val=Number(document.getElementById("goal_"+cat).value);
    if(!isNaN(val)&&val>=0) GOALS[cat].value=val;
  });
  localStorage.setItem("lifetracker_goals",JSON.stringify(GOALS));
  alert("Ziele gespeichert!");
  loadData();
}

// =====================
// Daten laden + Chart
// =====================
async function loadData(){
  setLoading(true);
  try{
    const timerResp = await fetch(TIMER_URL);
    const counterResp = await fetch(COUNTER_URL);
    const timerData = normalizeArray(await timerResp.json());
    const counterData = normalizeArray(await counterResp.json());
    let totals={};
    // Kategorien sammeln
    timerData.forEach(e=>{ if(!CATEGORY_LIST.timer.includes(e.category)) CATEGORY_LIST.timer.push(e.category); });
    counterData.forEach(e=>{ if(!CATEGORY_LIST.counter.includes(e.category)) CATEGORY_LIST.counter.push(e.category); });
    localStorage.setItem("lifetracker_categories",JSON.stringify(CATEGORY_LIST));

    // Timer summieren
    if(currentMode==="timer"){
      timerData.forEach(e=>{ if(!isToday(e.start_ts)) return; totals[e.category]=(totals[e.category]||0)+Math.floor(e.duration_s/60); });
    }
    // Counter summieren
    if(currentMode==="counter"){
      counterData.forEach(e=>{ if(!isToday(e.timestamp)) return; totals[e.category]=(totals[e.category]||0)+e.value; });
    }

    // √úberkategorien summieren
    if(FOLDERS[currentMode]){
      Object.entries(FOLDERS[currentMode]).forEach(([over,subs])=>{
        totals[over]=subs.reduce((sum,sub)=>sum+(totals[sub]||0),0);
      });
    }

    // XP
    let xpToday=0;
    let xpTotal=Number(localStorage.getItem("lifetracker_xp_total"))||0;
    Object.entries(totals).forEach(([cat,val])=>{
      const xp=calculateXP(cat,val);
      xpToday+=xp; xpTotal+=xp;
    });
    localStorage.setItem("lifetracker_xp_total",xpTotal);
    document.getElementById("xpToday").textContent=xpToday;
    document.getElementById("xpTotal").textContent=xpTotal;

    renderChart(totals);
    renderGoalEditor();
    renderOvercategories();
  } catch(err){ console.error(err); alert("Fehler: "+err); }
  setLoading(false);
}

function setLoading(is){ const btn=document.getElementById("refreshBtn"); btn.disabled=is; btn.innerHTML=is?"‚è≥ L√§dt‚Ä¶":"üîÑ Aktualisieren"; btn.style.opacity=is?0.6:1; }

function renderChart(data){
  const ctx=document.getElementById("todayChart");
  if(chart) chart.destroy();
  const labels=Object.keys(data);
  const values=Object.values(data);
  const goalLines=labels.map(cat=>GOALS[cat]?.value??null);
  chart=new Chart(ctx,{ type:"bar", data:{ labels, datasets:[
    { label:"Heute", data:values, backgroundColor: labels.map(cat=>GOALS[cat]&&data[cat]>=GOALS[cat].value?"#22c55e":"#3b82f6") },
    { label:"Ziel", data:goalLines, type:"line", borderColor:"#facc15", borderWidth:2, pointRadius:0 }
  ]}, options:{ responsive:true, scales:{ y:{ beginAtZero:true } } }});
}

// =====================
// Init
// =====================
loadData();

// Navigation Highlight
const page=location.pathname.split("/").pop();
if(page.includes("index")) document.getElementById("navHome").classList.add("active");
if(page.includes("dashboard")) document.getElementById("navDashboard").classList.add("active");
if(page.includes("analytics")) document.getElementById("navAnalytics").classList.add("active");
</script>
</body>
</html>
