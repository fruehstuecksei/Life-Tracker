<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LifeTracker ‚Äì Dashboard Heute</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
    font-family: Inter, sans-serif;
    background: #0f172a;
    color: #f1f5f9;
    padding: 20px;
    padding-bottom: 120px;
}
h1 { text-align:center; margin-bottom:20px; }

#xpBox, #chartContainer, #goalEditor {
    background: rgba(255,255,255,0.06);
    padding: 20px;
    border-radius: 12px;
    margin-bottom: 30px;
}

.goalRow {
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:12px;
    gap:10px;
}

.goalRow input {
    width:90px;
    padding:6px;
    border-radius:8px;
    border:none;
    background:#1e293b;
    color:white;
    text-align:right;
}

.modeBtn {
    padding:8px 14px;
    margin:0 4px;
    border-radius:10px;
    border:none;
    cursor:pointer;
    font-weight:600;
    background:#1e293b;
    color:white;
    opacity:0.6;
    transition:0.2s;
}
.modeBtn.active {
    opacity:1;
    background:#3b82f6;
}

#bottomNav {
    position:fixed;
    bottom:0;
    left:0;
    right:0;
    height:60px;
    background:rgba(255,255,255,0.06);
    backdrop-filter:blur(20px);
    border-top:1px solid rgba(255,255,255,0.1);
    display:flex;
    justify-content:space-around;
    align-items:center;
}

.navItem {
    color:#f1f5f9;
    font-size:26px;
    text-decoration:none;
    opacity:0.6;
}
.navItem.active {
    opacity:1;
    transform:translateY(-4px);
}

/* Tag-Chips */
.tag-bar {
    display:flex;
    flex-wrap:wrap;
    justify-content:center;
    gap:8px;
    margin-bottom:20px;
}

.tag-chip {
    padding:6px 12px;
    border-radius:12px;
    background:#1e293b;
    cursor:pointer;
    user-select:none;
    transition:0.2s;
    font-size:14px;
}
.tag-chip.active {
    background:#3b82f6;
}
</style>
</head>

<body>

<h1>üìä Dashboard ‚Äì Heute</h1>

<div style="text-align:center;margin-bottom:20px;">
    <button onclick="loadData()" style="
        padding:10px 16px;
        border-radius:12px;
        border:none;
        font-weight:600;
        background:#3b82f6;
        color:white;
        cursor:pointer;">
        üîÑ Aktualisieren
    </button>
</div>

<div style="text-align:center;margin-bottom:20px;">
    <button onclick="setMode('timer')" id="btnTimer" class="modeBtn active">Timer</button>
    <button onclick="setMode('counter')" id="btnCounter" class="modeBtn">Counter</button>
</div>

<div style="text-align:center;margin-bottom:20px;">
    <button onclick="setView('categories')" id="btnCategories" class="modeBtn active">Kategorien</button>
    <button onclick="setView('tags')" id="btnTags" class="modeBtn">Tags</button>
</div>

<!-- Tag-Bar -->
<div id="tagBar" class="tag-bar"></div>

<div id="xpBox">
    XP heute: <span id="xpToday">0</span>
</div>

<div id="chartContainer">
    <canvas id="todayChart"></canvas>
</div>

<div id="goalEditor">
    <h3>Einstellungen (<span id="goalModeLabel">Timer</span>)</h3>
    <div id="goalList"></div>
    <button onclick="saveGoals()" style="
        margin-top:10px;
        padding:8px 14px;
        border:none;
        border-radius:10px;
        background:#3b82f6;
        color:white;
        font-weight:600;
        cursor:pointer;">
        Speichern
    </button>
</div>

<nav id="bottomNav">
    <a href="index.html" class="navItem">üè†</a>
    <a href="dashboard.html" class="navItem active">üìä</a>
    <a href="analytics.html" class="navItem">üìà</a>
</nav>

<!-- TAG MODAL -->
<div id="tagModal" style="
position:fixed;
inset:0;
background:rgba(0,0,0,0.6);
display:none;
align-items:center;
justify-content:center;
z-index:2000;">

<div style="
background:#1e293b;
padding:20px;
border-radius:16px;
width:320px;
max-height:80vh;
overflow-y:auto;">

<h3 id="tagModalTitle">Tags</h3>
<div id="tagList" style="margin-top:15px;"></div>

<div style="margin-top:15px;">
<input id="newTagInput" placeholder="Neuer Tag..." style="
width:100%;
padding:8px;
border-radius:8px;
border:none;
background:#0f172a;
color:white;">
<button onclick="addTag()" style="
margin-top:8px;
width:100%;
padding:8px;
border:none;
border-radius:8px;
background:#3b82f6;
color:white;
font-weight:600;
cursor:pointer;">
‚ûï Hinzuf√ºgen
</button>
</div>

<button onclick="closeTagModal()" style="
margin-top:15px;
width:100%;
padding:8px;
border:none;
border-radius:8px;
background:#475569;
color:white;
cursor:pointer;">
Schlie√üen
</button>

</div>
</div>

<script>
const TIMER_URL="https://n8n.srv1377935.hstgr.cloud/webhook/lifetracker.timer";
const COUNTER_URL="https://n8n.srv1377935.hstgr.cloud/webhook/lifetracker.counter";

let GOALS=JSON.parse(localStorage.getItem("lifetracker_goals"))||{};
let CATEGORY_TAGS=JSON.parse(localStorage.getItem("lifetracker_tags"))||{};
let categoryTypes={};
let currentMode="timer";
let currentView="categories";
let chart;
let activeTagCategory=null;
let selectedTag=""; // f√ºr Tag-Chips

function normalizeArray(data){ if(!data) return []; if(Array.isArray(data)) return data; return [data]; }
function isToday(ts){ if(!ts) return false; const d=new Date(ts*1000); return d.toDateString()===new Date().toDateString(); }
function calculateXP(cat,val){ if(!GOALS[cat]) return 0; return val>=GOALS[cat]?10:0; }

function setMode(mode){
    currentMode=mode;
    document.getElementById("btnTimer").classList.toggle("active",mode==="timer");
    document.getElementById("btnCounter").classList.toggle("active",mode==="counter");
    document.getElementById("goalModeLabel").textContent=mode==="timer"?"Timer":"Counter";
    loadData();
}

function setView(view){
    currentView=view;
    document.getElementById("btnCategories").classList.toggle("active",view==="categories");
    document.getElementById("btnTags").classList.toggle("active",view==="tags");
    document.getElementById("tagBar").style.display=view==="categories"?"flex":"none";
    loadData();
}

/* TAG MODAL */
function editTags(cat){
    activeTagCategory=cat;
    document.getElementById("tagModalTitle").textContent="Tags f√ºr "+cat;
    document.getElementById("tagModal").style.display="flex";
    renderTagList();
}
function closeTagModal(){ document.getElementById("tagModal").style.display="none"; }
function renderTagList(){
    const container=document.getElementById("tagList");
    container.innerHTML="";
    const tags=CATEGORY_TAGS[activeTagCategory]||[];
    if(tags.length===0){ container.innerHTML="<p style='opacity:0.6;'>Keine Tags vorhanden</p>"; return; }
    tags.forEach((tag,i)=>{
        container.innerHTML+=`
        <div style="display:flex;justify-content:space-between;
        align-items:center;background:#0f172a;padding:8px;
        border-radius:8px;margin-bottom:8px;">
        <span>${tag}</span>
        <button onclick="removeTag(${i})"
        style="background:#ef4444;border:none;padding:4px 8px;
        border-radius:6px;color:white;cursor:pointer;">‚úï</button>
        </div>`;
    });
}
function addTag(){
    const input=document.getElementById("newTagInput");
    const val=input.value.trim();
    if(!val) return;
    if(!CATEGORY_TAGS[activeTagCategory]) CATEGORY_TAGS[activeTagCategory]=[];
    if(!CATEGORY_TAGS[activeTagCategory].includes(val)) CATEGORY_TAGS[activeTagCategory].push(val);
    localStorage.setItem("lifetracker_tags",JSON.stringify(CATEGORY_TAGS));
    input.value="";
    renderTagList();
}
function removeTag(i){
    CATEGORY_TAGS[activeTagCategory].splice(i,1);
    localStorage.setItem("lifetracker_tags",JSON.stringify(CATEGORY_TAGS));
    renderTagList();
}

/* GOALS */
function renderGoalEditor(){
    const container=document.getElementById("goalList");
    container.innerHTML="";
    Object.entries(GOALS).forEach(([cat,goal])=>{
        if(categoryTypes[cat]!==currentMode) return;
        container.innerHTML+=`
        <div class="goalRow">
        <span>${cat}</span>
        <input id="goal_${cat}" type="number" value="${goal}">
        <button onclick="editTags('${cat}')"
        style="padding:6px 10px;border:none;border-radius:8px;
        background:#475569;color:white;cursor:pointer;">
        Tags</button>
        </div>`;
    });
}
function saveGoals(){
    Object.keys(GOALS).forEach(cat=>{
        if(categoryTypes[cat]!==currentMode) return;
        const val=Number(document.getElementById("goal_"+cat).value);
        if(!isNaN(val)) GOALS[cat]=val;
    });
    localStorage.setItem("lifetracker_goals",JSON.stringify(GOALS));
    loadData();
}

/* TAG BAR */
function renderTagBar(){
    const container=document.getElementById("tagBar");
    container.innerHTML="";
    const allTags=new Set();
    Object.values(CATEGORY_TAGS).forEach(tags=>tags.forEach(t=>allTags.add(t)));

    const allChip=document.createElement("div");
    allChip.textContent="Alle";
    allChip.className="tag-chip "+(selectedTag===""?"active":"");
    allChip.onclick=()=>{ selectedTag=""; renderTagBar(); loadData(); };
    container.appendChild(allChip);

    allTags.forEach(tag=>{
        const chip=document.createElement("div");
        chip.textContent=tag;
        chip.className="tag-chip "+(selectedTag===tag?"active":"");
        chip.onclick=()=>{ selectedTag=tag; renderTagBar(); loadData(); };
        container.appendChild(chip);
    });
}

/* LOAD DATA */
async function loadData(){
    const tRes=await fetch(TIMER_URL);
    const cRes=await fetch(COUNTER_URL);
    const timerData=normalizeArray(await tRes.json());
    const counterData=normalizeArray(await cRes.json());
    const totals={};

    timerData.forEach(e=>categoryTypes[e.category]="timer");
    counterData.forEach(e=>categoryTypes[e.category]="counter");

    Object.keys(categoryTypes).forEach(cat=>{
        if(!GOALS[cat]) GOALS[cat]=categoryTypes[cat]==="timer"?60:10;
    });

    renderGoalEditor();
    renderTagBar();

    if(currentMode==="timer"){
        timerData.forEach(e=>{
            if(!isToday(e.start_ts)) return;
            totals[e.category]=(totals[e.category]||0)+Math.floor(e.duration_s/60);
        });
    }

    if(currentMode==="counter"){
        counterData.forEach(e=>{
            if(!isToday(e.timestamp)) return;
            totals[e.category]=(totals[e.category]||0)+e.value;
        });
    }

    /* TAG VIEW */
    if(currentView==="tags"){
        const tagTotals={};
        Object.entries(totals).forEach(([cat,val])=>{
            const tags=CATEGORY_TAGS[cat]||[];
            tags.forEach(tag=>{
                tagTotals[tag]=(tagTotals[tag]||0)+val;
            });
        });
        renderChart(tagTotals);
        return;
    }

    /* CATEGORY VIEW + TAG FILTER */
    const categoriesOfMode = Object.keys(categoryTypes).filter(cat=>categoryTypes[cat]===currentMode);
    const filteredCategories = selectedTag ? categoriesOfMode.filter(cat => (CATEGORY_TAGS[cat]||[]).includes(selectedTag)) : categoriesOfMode;
    const displayData = {};
    filteredCategories.forEach(cat=>displayData[cat]=totals[cat]||0);

    let xp=0;
    Object.entries(displayData).forEach(([cat,val])=>xp+=calculateXP(cat,val));
    document.getElementById("xpToday").textContent=xp;

    renderChart(displayData);
}

function renderChart(data){
    const ctx=document.getElementById("todayChart");
    if(chart) chart.destroy();
    chart=new Chart(ctx,{
        type:"bar",
        data:{labels:Object.keys(data),datasets:[{label:currentView==="tags"?"Tag Summe":"Heute",data:Object.values(data),backgroundColor:"#3b82f6"}]},
        options:{responsive:true,scales:{y:{beginAtZero:true}}}
    });
}

loadData();
</script>

</body>
</html>
